<?php

/**
 * @file
 * fetch data from taobao and, generate the report for product ranking
 */

function tbtrack_menu() {
  $menu = array();

  $menu['tbtrack'] = array(
    'title' => 'Taobao tracker instructions',
    'page callback' => 'tbtrack_instructions',
    'access callback' => TRUE,
    'expanded' => TRUE,
  );

  $menu['tbtrack/ranking'] = array(
    'title' => 'Taobao tracker ranking instructions',
    'page callback' => 'tbtrack_ranking_instructions',
    'access callback' => TRUE,
    'file' => 'tbtrack.ranking.inc',
    'expanded' => TRUE,
  );

  $menu['tbtrack/ranking/default'] = array(
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'title' => 'Instructions',
    'weight' => 1,
  );

  $menu['tbtrack/ranking/all'] = array(
    'type' => MENU_LOCAL_TASK,
    'title' => 'Taobao track fetch all',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tbtrack_ranking_query_all_form'),
    'access callback' => TRUE,
    'file' => 'tbtrack.ranking.inc',
    'weight' => 10,
  );

  $menu['tbtrack/ranking/query'] = array(
    'type' => MENU_LOCAL_TASK,
    'title' => 'Taobao track form',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tbtrack_ranking_query_form'),
    'access callback' => TRUE,
    'file' => 'tbtrack.ranking.inc',
    'weight' => 5,
  );

  return $menu;
}

/**
 * tbtrack module instructions callback
 */
function tbtrack_instructions() {
  $output = array();
  return $output;
}

/**
 * render helper function
 */
function _tbtrack_add_div($markup, $element) {
  return "<div style='display:block'>" . $markup . "</div>";
}

/**
 * Receive platform data from defined in this function and hook returns
 */
function tbtrack_get_platform_info() {
  return  module_invoke_all('tbtrack_platform_info');
}

/**
 * create product id field for product node
 */
function tbtrack_create_field_product_id($field_name, $label) {
  // create id field for tmall product
  $field = array(
    'field_name' => $field_name,
    'cardinality' => 1,
    'type' => 'text',
    'settings'    => array(
      'max_length' => 60,
    ),
  );

  if (!field_info_field($field_name)) {
    field_create_field($field);
  }

  // create id field instance
  $instance = array(
    'entity_type' => 'node',
    'bundle' => 'products',
    'field_name' => $field_name,
    'label' => $label,
    'widget' => array(
      'type' => 'text_textfield',
    ),
  );
  if (!field_info_instance($instance['entity_type'], $instance['field_name'], $instance['bundle'])) {
      field_create_instance($instance);
  }
}

/**
 * delete product id field by field_name
 */
function tbtrack_delete_field_product_id($field_name) {
  if (field_info_field($field_name)) {
    field_delete_field($field_name);
  }
  $instance = array(
    'entity_type' => 'node',
    'field_name' => $field_name,
    'bundle' => 'products',
  );
  if (field_info_instance($instance['entity_type'], $instance['field_name'], $instance['bundle'])) {
    field_delete_instance($instance);
  }
}